#!/usr/bin/env bash
# aqua-installer - shell script to install aqua
# https://github.com/aquaproj/aqua-installer

set -eu

usage_exit() {
  echo "Usage: $0 [-v version]" 1>&2
  exit 1
}

uname_os() {
  local os
  os=$(uname -s | tr '[:upper:]' '[:lower:]')
  case "$os" in
    cygwin_nt*) os="windows" ;;
    mingw*) os="windows" ;;
    msys_nt*) os="windows" ;;
  esac
  echo "$os"
}

uname_arch() {
  local arch
  arch=$(uname -m)
  case $arch in
    x86_64) arch="amd64" ;;
    aarch64) arch="arm64" ;;
  esac
  echo ${arch}
}

OS="$(uname_os)"
ARCH="$(uname_arch)"

install_path=${AQUA_ROOT_DIR:-${XDG_DATA_HOME:-$HOME/.local/share}/aquaproj-aqua}/bin/aqua
if [ "$OS" = windows ]; then
  install_path=${AQUA_ROOT_DIR:-$HOME/AppData/Local/aquaproj-aqua}/bin/aqua.exe
fi

while getopts v: OPT
do
  case $OPT in
    v) version=$OPTARG
      ;;
    \?) usage_exit
      ;;
  esac
done

shift $((OPTIND - 1))

bootstrap_version=v1.25.1-2
filename=aqua_${OS}_${ARCH}.tar.gz
URL=https://github.com/aquaproj/aqua/releases/download/$bootstrap_version/$filename

tempdir=$(mktemp -d)
echo "===> Installing aqua $bootstrap_version for bootstraping..." >&2
echo "===> Downloading $URL ..." >&2
curl --fail -L "$URL" -o "$tempdir/$filename"

echo "===> Verifying checksum of aqua $bootstrap_version ..." >&2
echo "03b11edde191ebc12a9b3dcf9d7bfd2bca7231c9e9114c3d23c12850e382712d  aqua_windows_amd64.tar.gz
1dc24ea1c4ed77138526e7208872c6dd4e879b529a60dac1380a989735e89651  aqua_windows_arm64.tar.gz
603cd4af0a45555ab0afa8c87aff52142635174a6254d33735bfac029e5c5c0e  aqua_darwin_amd64.tar.gz
685e34eeeec335469a2e07866f736c3bb3b0464e27da83b1a98dbf44e2e711b8  aqua_linux_amd64.tar.gz
7b5bc2ce9408a00e607b6dddc6d47d9efcc50b13a0757edbf0c41b3b927d4821  aqua_linux_arm64.tar.gz
d3256a5cbb64ccc94b829ca799b391e5ef357ff811a490ec7ab1196effd453bc  aqua_darwin_arm64.tar.gz" | grep "$filename" | sha256sum -c

(cd "$tempdir"; tar xvzf "$filename" > /dev/null)
chmod a+x "$tempdir/aqua"
if [ -n "${version:-}" ]; then
	echo "===> $tempdir/aqua update-aqua $version" >&2
	"$tempdir/aqua" update-aqua "$version"
else
	echo "===> $tempdir/aqua update-aqua" >&2
	"$tempdir/aqua" update-aqua
fi

rm -R "$tempdir"
"$install_path" -v
